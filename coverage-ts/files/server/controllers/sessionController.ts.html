
  <!DOCTYPE html>
  <html>
    <head>
      <title>sessionController.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">server/controllers/sessionController.ts</td><td class="">75.21%</td><td class="">80%</td><td class="">121</td><td class="">91</td><td class="">30</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import fetch from &#x27;node-fetch&#x27;;
import { Sessions } from &#x27;../models/reactypeModels&#x27;;
import dotenv from &#x27;dotenv&#x27;;
import { SessionController, SessionCookie } from &#x27;../interfaces&#x27;;

dotenv.config();
// here we are cheching that the user making the request is login in and has a valid cookieId
const sessionController: SessionController = {
  isLoggedIn: async (req, res, next) =&gt; {
    // if (process.env.NODE_ENV === &#x27;test&#x27;) {
    //   // Skip authentication checks in test environment
    //   return next();
    // } else {
      try {
        let cookieId;
        if (req.cookies) {
          // if the request cookies exist then it assigns it to cookieId
          cookieId = req.cookies.ssid;
        } else {
          // else it creates a new cookieId for the user based on the userId
          cookieId = req.body.userId;
        }

        // find session from request session ID in mongodb
        const session = await Sessions.findOne({ cookieId });
        if (!session) {
          console.log(&#x27;no session&#x27;)
          res.locals.loggedIn = false;
          return next();
          // return res.redirect(&#x27;/&#x27;);
        }
        res.locals.loggedIn = true;
        return next();
      } catch (err) {
        return next({
          log: `Error in sessionController.isLoggedIn: ${err}`,
          message: {
            err: &#x27;Error in sessionController.isLoggedIn, check server logs for details&#x27;
          }
        });
      }
    
},
  // startSession - create and save a new session into the database
  startSession: (req, res, next) =&gt; {
    // first check if user is logged in already
    Sessions.findOne({ cookieId: res.locals.id || req.user.id }, (err, ses) =&gt; {
      if (err) {
        return next({
          log: `Error in sessionController.startSession find session: ${err}`,
          message: {
            err: &#x27;Error in sessionController.startSession find session, check server logs for details&#x27;
          }
        });
        // if session doesn&#x27;t exist, create a session
        // if valid user logged in/signed up, res.locals.id should be user&#x27;s id generated from mongodb, which we will set as this session&#x27;s cookieId
      }
      if (!ses) {
        Sessions.create(
          //checking if logged in via the login form (res.locals.id) or oauth(req.user.id)
          { cookieId: res.locals.id || req.user.id },
          (error, session: SessionCookie) =&gt; {
            if (error) {
              return next({
                log: `Error in sessionController.startSession create session: ${error}`,
                message: {
                  err: &#x27;Error in sessionController.startSession create session, check server logs for details&#x27;
                }
              });
            }
            res.locals.ssid = session.cookieId;
            return next();
          }
        );
        // if session exists, move onto next middleware
      } else {
        res.locals.ssid = ses.cookieId;
        return next();
      }
    });
  },

  endSession: (req, res, next) =&gt; {
    //finding then deleting the session
    Sessions.findOneAndDelete({ cookieId: req.cookies.ssid }, null, (err, deleted) =&gt; {
      if (err) {
        return next({
          log: `Error in sessionController.endSession: ${err}`,
          message: {
            err: &#x27;Error in sessionController.endSession, check server logs for details&#x27;
          }
        });
      }
      res.locals.deleted = deleted;
      return next();
    });
  },

  //don&#x27;t think this code is used DW17
  // gitHubResponse: (req, res, next) =&gt; {
  //   const { code } = req.query;
  //   if (!code) {
  //     console.log(&#x27;code not found&#x27;);
  //     return next({
  //       log: &#x27;Undefined or no code received from github.com&#x27;,
  //       message: &#x27;Undefined or no code received from github.com&#x27;,
  //       status: 400
  //     });
  //   }
  //   fetch(
  //     `https://github.com/login/oauth/access_token?client_id=${process.env.GITHUB_ID}&amp;client_secret=${process.env.GITHUB_SECRET}&amp;code=${code}`,
  //     {
  //       method: &#x27;POST&#x27;,
  //       headers: {
  //         accept: &#x27;application/json&#x27;,
  //         &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
  //       },
  //       body: JSON.stringify({
  //         client_id: process.env.GITHUB_ID,
  //         client_secret: process.env.GITHUB_SECRET,
  //         code: code
  //       })
  //     }
  //   )
  //     .then((res) =&gt; res.json())
  //     .then((token) =&gt; {
  //       res.locals.token = token[&#x27;access_token&#x27;];
  //       return next();
  //     })
  //     .catch((err) =&gt; {
  //       res.status(500).json({ message: `${err.message} in gitHubResponse` });
  //     });
  // },

  // gitHubSendToken: (req, res, next) =&gt; {
  //   const { token } = res.locals;
  //   fetch(`https://api.github.com/user/public_emails`, {
  //     method: &#x27;GET&#x27;,
  //     headers: {
  //       Accept: &#x27;application/vnd.github.v3+json&#x27;,
  //       Authorization: `token ${token}`
  //     }
  //   })
  //     .then((res) =&gt; res.json())
  //     .then((data) =&gt; {
  //       res.locals.githubEmail = data[0][&#x27;email&#x27;];
  //       res.locals.signUpType = &#x27;oauth&#x27;;
  //       console.log(
  //         &#x27;github email:&#x27;,
  //         res.locals.githubEmail,
  //         &#x27;signup type:&#x27;,
  //         res.locals.signUpType
  //       );
  //       return next();
  //     })
  //     .catch((err) =&gt; {
  //       if (err.message === `Cannot read property &#x27;email&#x27; of undefined`) {
  //         return res
  //           .status(400)
  //           .json({ message: `${err.message} in gitHubSendToken` });
  //       } else {
  //         return res
  //           .status(500)
  //           .json({ message: `${err.message} in gitHubSendToken` });
  //       }
  //     });
  // },

  // // creates a session when logging in with github
  // githubSession: (req, res, next) =&gt; {
  //   // req.user is passed in from passport js -&gt; serializeuser/deserializeuser
  //   const cookieId = req.user.id;
  //   Sessions.findOne({ cookieId }, (err, session: SessionCookie) =&gt; {
  //     if (err) {
  //       return next({
  //         log: `Error in sessionController.githubSession find session: ${err}`,
  //         message: {
  //           err: `Error in sessionController.githubSession find session, check server logs for details`
  //         }
  //       });
  //     } else if (!session) {
  //       Sessions.create({ cookieId }, (err, session: SessionCookie) =&gt; {
  //         if (err) {
  //           return next({
  //             log: `Error in sessionController.githubSession create session: ${err}`,
  //             message: {
  //               err: `Error in sessionController.githubSession create session, check server logs for details`
  //             }
  //           });
  //         } else {
  //           res.locals.id = session.cookieId;
  //           return next();
  //         }
  //       });
  //     } else {
  //       res.locals.id = session.cookieId;
  //       return next();
  //     }
  //   });
  // }
};

export default sessionController;
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:14,&quot;character&quot;:12,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:15,&quot;character&quot;:16,&quot;text&quot;:&quot;cookies&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:17,&quot;character&quot;:10,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:17,&quot;character&quot;:25,&quot;text&quot;:&quot;cookies&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:17,&quot;character&quot;:33,&quot;text&quot;:&quot;ssid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:20,&quot;character&quot;:10,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:20,&quot;character&quot;:25,&quot;text&quot;:&quot;body&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:20,&quot;character&quot;:30,&quot;text&quot;:&quot;userId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:24,&quot;character&quot;:14,&quot;text&quot;:&quot;session&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:24,&quot;character&quot;:49,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:25,&quot;character&quot;:13,&quot;text&quot;:&quot;session&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:27,&quot;character&quot;:21,&quot;text&quot;:&quot;loggedIn&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:31,&quot;character&quot;:19,&quot;text&quot;:&quot;loggedIn&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:46,&quot;character&quot;:23,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:46,&quot;character&quot;:44,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:46,&quot;character&quot;:66,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:46,&quot;character&quot;:71,&quot;text&quot;:&quot;ses&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:47,&quot;character&quot;:10,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:49,&quot;character&quot;:72,&quot;text&quot;:&quot;err&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:57,&quot;character&quot;:11,&quot;text&quot;:&quot;ses&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:60,&quot;character&quot;:12,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:60,&quot;character&quot;:33,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:70,&quot;character&quot;:23,&quot;text&quot;:&quot;ssid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:19,&quot;text&quot;:&quot;ssid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:26,&quot;text&quot;:&quot;ses&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:76,&quot;character&quot;:30,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:84,&quot;character&quot;:32,&quot;text&quot;:&quot;cookieId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:84,&quot;character&quot;:46,&quot;text&quot;:&quot;cookies&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:84,&quot;character&quot;:54,&quot;text&quot;:&quot;ssid&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;server/controllers/sessionController.ts&quot;,&quot;line&quot;:93,&quot;character&quot;:17,&quot;text&quot;:&quot;deleted&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Sat, 28 Oct 2023 14:16:19 GMT</p>
    </body>
  </html>
  